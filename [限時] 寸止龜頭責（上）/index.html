<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Service Worker 自动注册示范</title>
</head>
<body>
  <h1>Service Worker 自动注册示范</h1>
  <video id="video" controls width="640" height="360"></video>

  <script src="https://lib.baomitu.com/hls.js/latest/hls.min.js"></script>

  <script>
    async function registerSW() {
      if (!('serviceWorker' in navigator)) {
        console.warn('浏览器不支持 Service Worker');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('Service Worker 注册成功:', registration.scope);

        // 监听控制器变化事件
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('检测到 SW 控制器变化，刷新页面');
          if (!window.location.search.includes('swReloaded')) {
            const connector = window.location.search ? '&' : '?';
            window.location.href = window.location.href + connector + 'swReloaded=1';
          }
        });

        if (navigator.serviceWorker.controller) {
          // SW 已经控制页面，启动播放器
          console.log('页面已被 SW 控制，启动播放器');
          startPlayer();
        } else {
          console.log('等待 SW 控制页面...');
          // 控制器变化后会自动刷新并启动播放器
        }
      } catch (e) {
        console.error('Service Worker 注册失败:', e);
      }
    }

    function startPlayer() {
      const video = document.getElementById('video');

      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource('index.m3u8');
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play().catch(e => {
            console.warn('自动播放被阻止，用户需操作后播放', e);
          });
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = 'index.m3u8';
        video.addEventListener('loadedmetadata', () => {
          video.play().catch(e => {
            console.warn('自动播放被阻止，用户需操作后播放', e);
          });
        });
      } else {
        alert('浏览器不支持 HLS 播放');
      }
    }

    registerSW();
  </script>
</body>
</html>
