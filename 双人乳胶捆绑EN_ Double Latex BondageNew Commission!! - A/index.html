<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Base64 HLS 播放测试</title>
  <script src="https://lib.baomitu.com/hls.js/latest/hls.min.js"></script>
</head>
<body>
  <h2>Base64 编码 HLS 播放测试</h2>
  <video id="video" controls width="640" height="360"></video>

  <script>
  async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('sw.js');
      console.log('Service Worker 注册成功:', registration.scope);

      await navigator.serviceWorker.ready;
      console.log('Service Worker 已激活');
    } catch (e) {
      console.error('Service Worker 注册失败:', e);
      alert('SW注册失败，详细请看控制台');
    }
  } else {
    console.warn('浏览器不支持 Service Worker');
  }
}


  function startPlayer() {
    // 播放逻辑...
    console.log('播放器启动');
  }

  (async () => {
    if (navigator.serviceWorker.controller) {
      console.log('已由 Service Worker 控制，启动播放器');
      startPlayer();
    } else {
      if (!localStorage.getItem('swRegistered')) {
        console.log('开始注册 Service Worker');
        await registerServiceWorker();
        localStorage.setItem('swRegistered', 'true');
        console.log('注册完毕，刷新页面使其生效');
        location.reload();
      } else {
        console.log('已刷新过一次但 SW 尚未控制页面，避免死循环，启动播放器');
        startPlayer();
      }
    }
  })();
</script>
</body>
</html>
